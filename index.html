<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GlowCare</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  </head>
  <body>
    <header class="navbar">
      <div class="container">
        <a href="#" class="logo" onclick="showSection('home')">GlowCare</a>
        <nav>
          <ul>
            <li>
              <a href="#" onclick="showSection('home')"><i class="fas fa-home"></i> Home</a>
            </li>
            <li>
              <a href="#" onclick="showSection('treatments')"><i class="fas fa-spa"></i> Treatments</a>
            </li>
            <li id="appointmentsNavItem" style="display: none">
              <a href="#" onclick="showSection('appointments')"><i class="fas fa-calendar-alt"></i> Appointments</a>
            </li>
            <li id="paymentsNavItem" style="display: none">
              <a href="#" onclick="showSection('payments')"><i class="fas fa-credit-card"></i> Payments</a>
            </li>
            <li id="profileNavItem" style="display: none">
              <a href="#" onclick="showSection('profile')"><i class="fas fa-user"></i> Profile</a>
            </li>
            <li id="authNavItem">
              <a href="login.html"><i class="fas fa-sign-in-alt"></i> Login/Register</a>
            </li>
            <li id="logoutNavItem" style="display: none">
              <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a>
            </li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="container">
      <section id="home" class="active">
        <h2>Welcome to GlowCare</h2>
        <p>Your path to radiant skin and ultimate relaxation. Explore our services and book your next appointment with ease.</p>
        <div class="hero-image"></div>
        <p>We offer a wide range of treatments designed to rejuvenate your mind, body, and spirit. From luxurious facials to relaxing massages, our expert team is here to provide you with the best care.</p>
      </section>

      <section id="profile" style="display: none">
        <h2>Your Profile</h2>
        <div id="profileDetails" class="card">
          <h3>Personal Information</h3>
          <p><strong>Name:</strong> <span id="profileName"></span></p>
          <p><strong>Email:</strong> <span id="profileEmail"></span></p>
          <p><strong>Role:</strong> <span id="profileRole"></span></p>
          <button class="btn btn-secondary" onclick="document.getElementById('editProfileFormCard').style.display='block'">Edit Profile</button>
        </div>

        <div id="editProfileFormCard" class="form-card" style="display: none">
          <h3>Edit Your Information</h3>
          <form id="editProfileForm">
            <div class="form-group">
              <label for="editName">New Name:</label>
              <input type="text" id="editName" placeholder="New Name" />
            </div>
            <div class="form-group">
              <label for="editEmail">New Email:</label>
              <input type="email" id="editEmail" placeholder="New Email" />
            </div>
            <div class="form-group">
              <label for="editPassword">New Password (optional):</label>
              <input type="password" id="editPassword" placeholder="Leave blank to keep current" />
            </div>
            <button type="submit" class="btn btn-primary">Update Profile</button>
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('editProfileFormCard').style.display='none'">Cancel</button>
          </form>
          <p id="editProfileMessage" class="message"></p>
        </div>
      </section>

      <section id="treatments" style="display: none">
        <h2>Available Treatments</h2>
        <div id="addTreatmentSection" style="display: none">
          <div class="form-card">
            <h3>Add New Treatment</h3>
            <form id="newTreatmentForm">
              <div class="form-group">
                <label for="newTreatmentName">Treatment Name:</label>
                <input type="text" id="newTreatmentName" placeholder="e.g., Facial Treatment" required />
              </div>
              <div class="form-group">
                <label for="newTreatmentDescription">Description:</label>
                <textarea id="newTreatmentDescription" placeholder="Detailed description of the treatment"></textarea>
              </div>
              <div class="form-group">
                <label for="newTreatmentPrice">Price (Rp):</label>
                <input type="number" id="newTreatmentPrice" placeholder="e.g., 150000" required />
              </div>
              <div class="form-group">
                <label for="newTreatmentDuration">Duration (minutes):</label>
                <input type="number" id="newTreatmentDuration" placeholder="e.g., 60" required />
              </div>
              <button type="submit" class="btn btn-primary">Add Treatment</button>
            </form>
            <p id="addTreatmentMessage" class="message"></p>
          </div>
        </div>
        <div id="treatmentsList" class="grid-container">
          <p>Loading treatments...</p>
        </div>
      </section>

      <section id="appointments" style="display: none">
        <h2>Appointments</h2>
        <div id="bookAppointmentSection" class="form-card" style="display: none">
          <h3>Book a New Appointment</h3>
          <form id="appointmentBookingForm">
            <div class="form-group">
              <label for="bookingTreatment">Select Treatment:</label>
              <select id="bookingTreatment" required>
                <option value="">-- Loading Treatments --</option>
              </select>
            </div>
            <div class="form-group">
              <label for="appointmentDate">Appointment Date & Time:</label>
              <input type="datetime-local" id="appointmentDate" required />
            </div>
            <button type="submit" class="btn btn-primary">Book Appointment</button>
          </form>
          <p id="appointmentBookingMessage" class="message"></p>
        </div>

        <h3>Upcoming & Past Appointments</h3>
        <div id="appointmentsList" class="list-container">
          <p>Loading appointments...</p>
        </div>
      </section>

      <section id="payments" style="display: none">
        <h2>Payments Overview</h2>
        <div id="createPaymentSection" class="form-card" style="display: none">
          <h3>Initiate New Payment</h3>
          <form id="paymentCreationForm">
            <div class="form-group">
              <label for="paymentAppointmentId">Appointment ID:</label>
              <input type="number" id="paymentAppointmentId" placeholder="ID of the appointment" required />
            </div>
            <div class="form-group">
              <label for="paymentAmount">Amount (Rp):</label>
              <input type="number" id="paymentAmount" placeholder="Amount (auto-filled)" readonly required />
            </div>
            <div class="form-group">
              <label for="paymentMethod">Payment Method:</label>
              <input type="text" id="paymentMethod" placeholder="e.g., transfer, cash, credit_card" required />
            </div>
            <button type="submit" class="btn btn-primary">Create Payment Request</button>
          </form>
          <p id="createPaymentMessage" class="message"></p>
        </div>

        <h3>All Your Payments</h3>
        <div id="paymentsList" class="list-container">
          <p>Loading payments...</p>
        </div>
      </section>
    </main>

    <script>
      const USER_SERVICE_URL = "http://localhost:5001";
      const APPOINTMENT_SERVICE_URL = "http://localhost:5002";
      const TREATMENT_SERVICE_URL = "http://localhost:5003";
      const PAYMENT_SERVICE_URL = "http://localhost:5004";

      let accessToken = localStorage.getItem("access_token") || null;
      let currentUserRole = localStorage.getItem("user_role") || null;
      let currentUserId = localStorage.getItem("user_id") || null;

      // Function to show/hide sections
      function showSection(sectionId) {
        // Hide all sections
        const sections = document.querySelectorAll("main section");
        sections.forEach((section) => {
          section.style.display = "none";
        });

        // Show the requested section
        const targetSection = document.getElementById(sectionId);
        if (targetSection) {
          targetSection.style.display = "block";
        }

        // Load data based on section
        switch (sectionId) {
          case "profile":
            if (accessToken) {
              fetchUserProfile();
            } else {
              alert("Please log in to view your profile.");
              window.location.href = "login.html";
              return;
            }
            break;
          case "treatments":
            fetchTreatments();
            break;
          case "appointments":
            if (accessToken) {
              fetchAppointments();
              fetchTreatmentsForBooking();
              // Show booking section for patients
              if (currentUserRole === "pasien") {
                document.getElementById("bookAppointmentSection").style.display = "block";
              } else {
                document.getElementById("bookAppointmentSection").style.display = "none";
              }
            } else {
              alert("Please log in to view appointments.");
              window.location.href = "login.html";
              return;
            }
            break;
          case "payments":
            if (accessToken) {
              fetchPayments();
              // Show payment creation section for patients
              if (currentUserRole === "pasien") {
                document.getElementById("createPaymentSection").style.display = "block";
              } else {
                document.getElementById("createPaymentSection").style.display = "none";
              }
            } else {
              alert("Please log in to view payments.");
              window.location.href = "login.html";
              return;
            }
            break;
        }
      }

      // Update navigation based on authentication status
      function updateAuthNav() {
        console.log("Updating nav - Token:", !!accessToken, "Role:", currentUserRole, "UserID:", currentUserId);

        const appointmentsNav = document.getElementById("appointmentsNavItem");
        const paymentsNav = document.getElementById("paymentsNavItem");
        const profileNav = document.getElementById("profileNavItem");
        const authNav = document.getElementById("authNavItem");
        const logoutNav = document.getElementById("logoutNavItem");

        if (accessToken && currentUserRole) {
          // User is logged in - show authenticated nav items
          authNav.style.display = "none";
          profileNav.style.display = "list-item";
          logoutNav.style.display = "list-item";

          // Show nav items based on role
          if (currentUserRole === "pasien") {
            appointmentsNav.style.display = "list-item";
            paymentsNav.style.display = "list-item";
          } else if (currentUserRole === "dokter") {
            appointmentsNav.style.display = "list-item";
            paymentsNav.style.display = "none"; // Doctors don't access payments
          } else if (currentUserRole === "admin") {
            appointmentsNav.style.display = "list-item";
            paymentsNav.style.display = "list-item";
          }

          console.log("‚úÖ Navigation updated for authenticated user");
        } else {
          // User is not logged in - show only public nav items
          appointmentsNav.style.display = "none";
          paymentsNav.style.display = "none";
          profileNav.style.display = "none";
          logoutNav.style.display = "none";
          authNav.style.display = "list-item";

          console.log("üìù Navigation updated for guest user");
        }
      }

      // Function to refresh authentication state
      function refreshAuthState() {
        accessToken = localStorage.getItem("access_token") || null;
        currentUserRole = localStorage.getItem("user_role") || null;
        currentUserId = localStorage.getItem("user_id") || null;

        console.log("üîÑ Refreshing auth state:", {
          hasToken: !!accessToken,
          role: currentUserRole,
          userId: currentUserId,
        });

        updateAuthNav();
      }

      // Enhanced logout function
      function logout() {
        console.log("üö™ Logging out user...");

        // Clear all stored data
        localStorage.removeItem("access_token");
        localStorage.removeItem("user_role");
        localStorage.removeItem("user_id");
        localStorage.removeItem("user_name");

        // Reset variables
        accessToken = null;
        currentUserRole = null;
        currentUserId = null;

        // Update navigation
        updateAuthNav();

        alert("Logged out successfully.");
        window.location.href = "login.html";
      }

      // Check if user just logged in (from URL params or localStorage flag)
      function checkLoginRedirect() {
        const urlParams = new URLSearchParams(window.location.search);
        const justLoggedIn = urlParams.get("login") === "success" || localStorage.getItem("just_logged_in") === "true";

        if (justLoggedIn) {
          localStorage.removeItem("just_logged_in"); // Clear flag
          refreshAuthState(); // Refresh auth state

          // Show appropriate section based on role
          if (currentUserRole === "admin") {
            showSection("treatments"); // Admin sees treatments first
          } else {
            showSection("home"); // Others see home
          }

          // Show welcome message
          const userName = localStorage.getItem("user_name") || "User";
          setTimeout(() => {
            alert(`Welcome back, ${userName}! You are logged in as ${currentUserRole}.`);
          }, 500);
        }
      }

      // Add connection status check
      async function checkAllServices() {
        const services = [
          { name: "User Service", url: USER_SERVICE_URL },
          { name: "Treatment Service", url: TREATMENT_SERVICE_URL },
          { name: "Appointment Service", url: APPOINTMENT_SERVICE_URL },
          { name: "Payment Service", url: PAYMENT_SERVICE_URL },
        ];

        console.log("Checking all services...");
        for (const service of services) {
          try {
            const response = await fetch(`${service.url}/health` || `${service.url}/`);
            console.log(`‚úÖ ${service.name}: OK`);
          } catch (error) {
            console.warn(`‚ùå ${service.name}: Not available`);
          }
        }
      }

      // Enhanced error handling for all fetch requests
      async function fetchWithAuth(url, options = {}) {
        const defaultOptions = {
          headers: {
            "Content-Type": "application/json",
            Accept: "application/json",
            ...(accessToken && { Authorization: `Bearer ${accessToken}` }),
          },
        };

        const finalOptions = {
          ...defaultOptions,
          ...options,
          headers: {
            ...defaultOptions.headers,
            ...options.headers,
          },
        };

        try {
          const response = await fetch(url, finalOptions);

          if (response.status === 401) {
            // Token expired or invalid
            // console.warn("Authentication failed, redirecting to login...");
            // logout();
            return null;
          }

          return response;
        } catch (error) {
          console.error("Network error:", error);
          throw new Error("Network connection failed. Please check if all services are running.");
        }
      }

      // Update existing functions to use fetchWithAuth
      async function fetchUserProfile() {
        if (!accessToken) return;
        try {
          const response = await fetchWithAuth(`${USER_SERVICE_URL}/profile`);
          if (!response) return;

          const data = await response.json();
          if (response.ok) {
            document.getElementById("profileName").textContent = data.name;
            document.getElementById("profileEmail").textContent = data.email;
            document.getElementById("profileRole").textContent = data.role;
            document.getElementById("editName").value = data.name;
            document.getElementById("editEmail").value = data.email;
          } else {
            console.error("Failed to fetch profile:", data.message);
            document.getElementById("profileDetails").innerHTML = '<p class="error-message">Failed to load profile. Please log in again.</p>';
          }
        } catch (error) {
          console.error("Error fetching profile:", error);
          document.getElementById("profileDetails").innerHTML = '<p class="error-message">Error fetching profile. Check your network.</p>';
        }
      }

      document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!accessToken) {
          document.getElementById("editProfileMessage").textContent = "Please log in.";
          document.getElementById("editProfileMessage").className = "message error";
          return;
        }
        const name = document.getElementById("editName").value;
        const email = document.getElementById("editEmail").value;
        const password = document.getElementById("editPassword").value;

        const updateData = {};
        if (name) updateData.name = name;
        if (email) updateData.email = email;
        if (password) updateData.password = password;

        try {
          const response = await fetch(`${USER_SERVICE_URL}/profile`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify(updateData),
          });
          const data = await response.json();
          document.getElementById("editProfileMessage").textContent = data.message;
          document.getElementById("editProfileMessage").className = response.ok ? "message success" : "message error";
          if (response.ok) {
            fetchUserProfile();
            document.getElementById("editProfileFormCard").style.display = "none";
          }
        } catch (error) {
          document.getElementById("editProfileMessage").textContent = "Error updating profile.";
          document.getElementById("editProfileMessage").className = "message error";
          console.error("Error:", error);
        }
      });

      async function fetchTreatments() {
        try {
          const response = await fetch(`${TREATMENT_SERVICE_URL}/treatments`);
          const treatments = await response.json();
          const treatmentsListDiv = document.getElementById("treatmentsList");
          treatmentsListDiv.innerHTML = "";

          if (!Array.isArray(treatments) || treatments.length === 0) {
            treatmentsListDiv.innerHTML = '<p class="info-message">No treatments available at the moment.</p>';
          } else {
            treatments.forEach((treatment) => {
              const treatmentCard = document.createElement("div");
              treatmentCard.className = "card treatment-card";
              let adminButtons = "";
              if (currentUserRole === "admin") {
                adminButtons = `<button class="btn btn-danger" onclick="deleteTreatment(${treatment.id})">Delete</button>`;
              }
              treatmentCard.innerHTML = `
                            <h3>${treatment.name}</h3>
                            <p>${treatment.description}</p>
                            <p><strong>Price:</strong> Rp ${treatment.price.toLocaleString("id-ID")}</p>
                            <p><strong>Duration:</strong> ${treatment.duration} minutes</p>
                            <div class="card-actions">${adminButtons}</div>
                        `;
              treatmentsListDiv.appendChild(treatmentCard);
            });
          }

          if (currentUserRole === "admin") {
            document.getElementById("addTreatmentSection").style.display = "block";
          } else {
            document.getElementById("addTreatmentSection").style.display = "none";
          }
        } catch (error) {
          document.getElementById("treatmentsList").innerHTML = '<p class="error-message">Error loading treatments. Please check if treatment service is running.</p>';
          console.error("Error:", error);
        }
      }

      document.getElementById("newTreatmentForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (currentUserRole !== "admin" || !accessToken) {
          document.getElementById("addTreatmentMessage").textContent = "Unauthorized action: Only admins can add treatments.";
          document.getElementById("addTreatmentMessage").className = "message error";
          return;
        }

        const name = document.getElementById("newTreatmentName").value;
        const description = document.getElementById("newTreatmentDescription").value;
        const price = parseInt(document.getElementById("newTreatmentPrice").value);
        const duration = parseInt(document.getElementById("newTreatmentDuration").value);

        try {
          const response = await fetch(`${TREATMENT_SERVICE_URL}/treatments`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({ name, description, price, duration }),
          });
          const data = await response.json();
          document.getElementById("addTreatmentMessage").textContent = data.message;
          document.getElementById("addTreatmentMessage").className = response.ok ? "message success" : "message error";
          if (response.ok) {
            fetchTreatments();
            document.getElementById("newTreatmentForm").reset();
          }
        } catch (error) {
          document.getElementById("addTreatmentMessage").textContent = "Error adding treatment. Check service connection.";
          document.getElementById("addTreatmentMessage").className = "message error";
          console.error("Error:", error);
        }
      });

      async function deleteTreatment(treatmentId) {
        if (!confirm("Are you sure you want to delete this treatment? This action cannot be undone.")) return;
        if (currentUserRole !== "admin" || !accessToken) {
          alert("Unauthorized action.");
          return;
        }
        try {
          const response = await fetch(`${TREATMENT_SERVICE_URL}/treatments/${treatmentId}`, {
            method: "DELETE",
            headers: {
              Authorization: `Bearer ${accessToken}`,
            },
          });
          const data = await response.json();
          alert(data.message);
          if (response.ok) {
            fetchTreatments();
          }
        } catch (error) {
          alert("Error deleting treatment. Check service connection.");
          console.error("Error:", error);
        }
      }

      async function fetchTreatmentsForBooking() {
        try {
          const response = await fetch(`${TREATMENT_SERVICE_URL}/treatments`);
          const treatments = await response.json();
          const selectElement = document.getElementById("bookingTreatment");
          selectElement.innerHTML = '<option value="">-- Select a Treatment --</option>';

          if (treatments.length === 0) {
            selectElement.innerHTML = '<option value="">-- No Treatments Available --</option>';
          } else {
            treatments.forEach((treatment) => {
              const option = document.createElement("option");
              option.value = treatment.id;
              option.textContent = `${treatment.name} (Rp ${treatment.price.toLocaleString("id-ID")}, ${treatment.duration} mins)`;
              selectElement.appendChild(option);
            });
          }
        } catch (error) {
          console.error("Error loading treatments for booking:", error);
          document.getElementById("bookingTreatment").innerHTML = '<option value="">-- Error Loading Treatments --</option>';
        }
      }

      document.getElementById("appointmentBookingForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!accessToken || currentUserRole !== "pasien") {
          document.getElementById("appointmentBookingMessage").textContent = "Unauthorized: Only patients can book an appointment.";
          document.getElementById("appointmentBookingMessage").className = "message error";
          return;
        }

        const treatmentId = document.getElementById("bookingTreatment").value;
        const appointmentDate = document.getElementById("appointmentDate").value;

        if (!treatmentId || !appointmentDate) {
          document.getElementById("appointmentBookingMessage").textContent = "Please select a treatment and date/time.";
          document.getElementById("appointmentBookingMessage").className = "message error";
          return;
        }

        // Get treatment name for display
        const treatmentSelect = document.getElementById("bookingTreatment");
        const selectedTreatmentText = treatmentSelect.options[treatmentSelect.selectedIndex].text;

        console.log("Booking appointment with:", {
          user_id: currentUserId,
          treatment_id: parseInt(treatmentId),
          appointment_date: appointmentDate,
        });

        // Show loading state
        const messageElement = document.getElementById("appointmentBookingMessage");
        messageElement.textContent = "‚è≥ Creating your appointment...";
        messageElement.className = "message info";

        // Disable submit button
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Booking...';

        try {
          const response = await fetch(`${APPOINTMENT_SERVICE_URL}/appointments`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              user_id: parseInt(currentUserId),
              treatment_id: parseInt(treatmentId),
              appointment_date: appointmentDate,
            }),
          });

          const data = await response.json();
          console.log("Appointment booking response:", data);

          if (response.ok && data.success) {
            // Format appointment date nicely
            const appointmentDateTime = new Date(appointmentDate);
            const formattedDate = appointmentDateTime.toLocaleDateString("id-ID", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            const formattedTime = appointmentDateTime.toLocaleTimeString("id-ID", {
              hour: "2-digit",
              minute: "2-digit",
            });

            // Show success message with details
            messageElement.innerHTML = `
                  <div class="booking-success">
                      <h4>üéâ Appointment Booked Successfully!</h4>
                      <div class="appointment-details">
                          <p><strong>Appointment ID:</strong> <span class="highlight">#${data.appointment.id}</span></p>
                          <p><strong>Treatment:</strong> ${selectedTreatmentText}</p>
                          <p><strong>Date:</strong> ${formattedDate}</p>
                          <p><strong>Time:</strong> ${formattedTime}</p>
                          <p><strong>Status:</strong> <span class="status ${data.appointment.status}">${data.appointment.status.toUpperCase()}</span></p>
                      </div>
                      <p class="note">üí° Please save your appointment ID for future reference.</p>
                  </div>
              `;
            messageElement.className = "message success";

            // Refresh appointments list
            fetchAppointments();

            // Reset form
            document.getElementById("appointmentBookingForm").reset();

            // Show notification
            setTimeout(() => {
              alert(`Appointment #${data.appointment.id} has been booked successfully!\n\nTreatment: ${selectedTreatmentText}\nDate: ${formattedDate}\nTime: ${formattedTime}`);
            }, 500);
          } else {
            messageElement.textContent = data.message || "Failed to book appointment.";
            messageElement.className = "message error";
          }
        } catch (error) {
          console.error("Error booking appointment:", error);
          messageElement.textContent = "‚ùå Error booking appointment. Check service connection.";
          messageElement.className = "message error";
        } finally {
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });

      // Update fetchAppointments function untuk menampilkan ID lebih prominent
      async function fetchAppointments() {
        if (!accessToken) {
          document.getElementById("appointmentsList").innerHTML = '<p class="info-message">Please log in to view appointments.</p>';
          return;
        }

        try {
          console.log("Fetching appointments for user:", currentUserId, "role:", currentUserRole);

          let url = `${APPOINTMENT_SERVICE_URL}/appointments`;
          if (currentUserRole === "pasien") {
            url += `?user_id=${currentUserId}`;
          }

          console.log("Fetching from URL:", url);

          const response = await fetch(url, {
            headers: {
              Accept: "application/json",
            },
          });

          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          const appointments = await response.json();
          console.log("Received appointments:", appointments);

          const appointmentsListDiv = document.getElementById("appointmentsList");
          appointmentsListDiv.innerHTML = "";

          if (!Array.isArray(appointments) || appointments.length === 0) {
            appointmentsListDiv.innerHTML = '<p class="info-message">No appointments found.</p>';
            return;
          }

          // Fetch treatment names for better display
          const treatmentCache = {};

          for (const appointment of appointments) {
            // Get treatment name if not in cache
            if (!treatmentCache[appointment.treatment_id]) {
              try {
                const treatmentResponse = await fetch(`${TREATMENT_SERVICE_URL}/treatments/${appointment.treatment_id}`);
                if (treatmentResponse.ok) {
                  const treatment = await treatmentResponse.json();
                  treatmentCache[appointment.treatment_id] = {
                    name: treatment.name,
                    price: treatment.price,
                  };
                } else {
                  treatmentCache[appointment.treatment_id] = {
                    name: `Treatment #${appointment.treatment_id}`,
                    price: 0,
                  };
                }
              } catch (error) {
                treatmentCache[appointment.treatment_id] = {
                  name: `Treatment #${appointment.treatment_id}`,
                  price: 0,
                };
              }
            }

            const appointmentCard = document.createElement("div");
            appointmentCard.className = "card appointment-card";

            let buttons = "";
            if (currentUserRole === "admin") {
              buttons += `<button class="btn btn-warning" onclick="cancelAppointment(${appointment.id})">Cancel</button> `;
              buttons += `<button class="btn btn-danger" onclick="deleteAppointment(${appointment.id})">Delete</button>`;
            } else if (currentUserRole === "pasien" && appointment.status === "pending") {
              buttons += `<button class="btn btn-warning" onclick="cancelAppointment(${appointment.id})">Cancel</button>`;
            }

            // Format date nicely
            const appointmentDate = new Date(appointment.appointment_date);
            const formattedDate = appointmentDate.toLocaleDateString("id-ID", {
              weekday: "long",
              year: "numeric",
              month: "long",
              day: "numeric",
            });
            const formattedTime = appointmentDate.toLocaleTimeString("id-ID", {
              hour: "2-digit",
              minute: "2-digit",
            });

            appointmentCard.innerHTML = `
                  <div class="appointment-header">
                      <h4>Appointment <span class="appointment-id">#${appointment.id}</span></h4>
                      <span class="status ${appointment.status}">${appointment.status.toUpperCase()}</span>
                  </div>
                  <div class="appointment-body">
                      <p><strong>Treatment:</strong> ${treatmentCache[appointment.treatment_id].name}</p>
                      <p><strong>Price:</strong> Rp ${treatmentCache[appointment.treatment_id].price.toLocaleString("id-ID")}</p>
                      <p><strong>Date:</strong> ${formattedDate}</p>
                      <p><strong>Time:</strong> ${formattedTime}</p>
                      <p><strong>Booked:</strong> ${new Date(appointment.created_at).toLocaleDateString("id-ID")}</p>
                  </div>
                  <div class="card-actions">${buttons}</div>
              `;
            appointmentsListDiv.appendChild(appointmentCard);
          }
        } catch (error) {
          console.error("Error fetching appointments:", error);
          document.getElementById("appointmentsList").innerHTML = '<p class="error-message">Error loading appointments. Check service connection.</p>';
        }
      }

      async function updateAppointmentStatus(appointmentId, status) {
        if (currentUserRole !== "admin" || !accessToken) {
          alert("Unauthorized action: Only admin can manage appointments.");
          return;
        }
        try {
          const response = await fetch(`${USER_SERVICE_URL}/appointments/${appointmentId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({ status }),
          });
          const data = await response.json();
          alert(data.message);
          if (response.ok) {
            fetchAppointments();
          } else {
            alert("Failed to update appointment status: " + (data.message || "Unknown error"));
          }
        } catch (error) {
          alert("Error updating appointment status. Check service connection.");
          console.error("Error:", error);
        }
      }

      async function cancelAppointment(appointmentId) {
        if (!confirm("Are you sure you want to cancel this appointment?")) return;
        if (!accessToken || (currentUserRole !== "pasien" && currentUserRole !== "admin")) {
          alert("Unauthorized: Only patients or admin can cancel appointments.");
          return;
        }
        try {
          const response = await fetch(`${APPOINTMENT_SERVICE_URL}/appointments/${appointmentId}/cancel`, {
            method: "POST",
            headers: { Authorization: `Bearer ${accessToken}` || "" },
          });
          const data = await response.json();
          alert(data.message);
          if (response.ok) {
            fetchAppointments();
          } else {
            alert("Failed to cancel appointment: " + (data.message || "Unknown error"));
          }
        } catch (error) {
          alert("Error cancelling appointment. Check service connection.");
          console.error("Error:", error);
        }
      }

      async function deleteAppointment(appointmentId) {
        if (!confirm("Are you sure you want to delete this appointment? This action cannot be undone.")) return;
        if (currentUserRole !== "admin" || !accessToken) {
          alert("Unauthorized action: Only admin can delete appointments.");
          return;
        }
        try {
          const response = await fetch(`${USER_SERVICE_URL}/appointments/${appointmentId}`, {
            method: "DELETE",
            headers: { Authorization: `Bearer ${accessToken}` },
          });
          const data = await response.json();
          alert(data.message);
          if (response.ok) {
            fetchAppointments();
          } else {
            alert("Failed to delete appointment: " + (data.message || "Unknown error"));
          }
        } catch (error) {
          alert("Error deleting appointment. Check service connection.");
          console.error("Error:", error);
        }
      }

      document.getElementById("paymentAppointmentId").addEventListener("change", async (e) => {
        const appointmentId = e.target.value;
        const paymentAmountInput = document.getElementById("paymentAmount");
        paymentAmountInput.value = "";
        paymentAmountInput.placeholder = "Fetching amount...";

        if (!appointmentId) {
          paymentAmountInput.placeholder = "Amount (auto-filled)";
          return;
        }

        try {
          const appointmentResponse = await fetch(`${APPOINTMENT_SERVICE_URL}/appointments/${appointmentId}`);
          if (!appointmentResponse.ok) {
            throw new Error(`Appointment not found for ID: ${appointmentId}`);
          }
          const appointmentData = await appointmentResponse.json();
          const treatmentId = appointmentData.treatment_id;

          const treatmentResponse = await fetch(`${TREATMENT_SERVICE_URL}/treatments/${treatmentId}`);
          if (!treatmentResponse.ok) {
            throw new Error(`Treatment not found for ID: ${treatmentId}`);
          }
          const treatmentData = await treatmentResponse.json();
          const amount = treatmentData.price;

          paymentAmountInput.value = amount;
          paymentAmountInput.placeholder = `Amount: Rp ${amount.toLocaleString("id-ID")}`;
        } catch (error) {
          paymentAmountInput.placeholder = "Error fetching amount";
          document.getElementById("createPaymentMessage").textContent = `Error: ${error.message}`;
          document.getElementById("createPaymentMessage").className = "message error";
          console.error("Error auto-filling amount:", error);
        }
      });

      document.getElementById("paymentCreationForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!accessToken || currentUserRole !== "pasien") {
          document.getElementById("createPaymentMessage").textContent = "Unauthorized: Only patients can create a payment.";
          document.getElementById("createPaymentMessage").className = "message error";
          return;
        }

        const appointmentId = parseInt(document.getElementById("paymentAppointmentId").value);
        const amount = parseInt(document.getElementById("paymentAmount").value);
        const paymentMethod = document.getElementById("paymentMethod").value.trim();

        if (!appointmentId || !amount || !paymentMethod) {
          document.getElementById("createPaymentMessage").textContent = "All fields are required for payment creation.";
          document.getElementById("createPaymentMessage").className = "message error";
          return;
        }

        console.log("Creating payment with:", {
          user_id: currentUserId,
          appointment_id: appointmentId,
          amount: amount,
          payment_method: paymentMethod,
        });

        // Show loading state
        const messageElement = document.getElementById("createPaymentMessage");
        messageElement.textContent = "‚è≥ Creating payment...";
        messageElement.className = "message info";

        // Disable submit button
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

        try {
          const response = await fetch(`${PAYMENT_SERVICE_URL}/payments`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Accept: "application/json",
            },
            body: JSON.stringify({
              user_id: parseInt(currentUserId),
              appointment_id: appointmentId,
              amount: amount,
              payment_method: paymentMethod,
            }),
          });

          const data = await response.json();
          console.log("Payment creation response:", data);

          if (response.ok && data.success) {
            // Show success message with payment details
            messageElement.innerHTML = `
                    <div class="payment-success">
                        <h4>üí≥ Payment Created Successfully!</h4>
                        <div class="payment-details">
                            <p><strong>Payment Reference:</strong> <span class="highlight">${data.payment.payment_reference}</span></p>
                            <p><strong>Appointment ID:</strong> #${data.payment.appointment_id}</p>
                            <p><strong>Amount:</strong> Rp ${data.payment.amount.toLocaleString("id-ID")}</p>
                            <p><strong>Method:</strong> ${data.payment.payment_method}</p>
                            <p><strong>Status:</strong> <span class="status ${data.payment.status}">${data.payment.status.toUpperCase()}</span></p>
                        </div>
                        <p class="note">üí° Please save your payment reference for tracking.</p>
                    </div>
                `;
            messageElement.className = "message success";

            // Refresh payments list
            fetchPayments();

            // Reset form
            document.getElementById("paymentCreationForm").reset();

            // Show notification
            setTimeout(() => {
              alert(`Payment created successfully!\n\nReference: ${data.payment.payment_reference}\nAmount: Rp ${data.payment.amount.toLocaleString("id-ID")}`);
            }, 500);
          } else {
            messageElement.textContent = data.message || "Failed to create payment.";
            messageElement.className = "message error";
          }
        } catch (error) {
          console.error("Error creating payment:", error);
          messageElement.textContent = "‚ùå Error creating payment. Check service connection.";
          messageElement.className = "message error";
        } finally {
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalText;
        }
      });

      async function fetchPayments() {
        if (!accessToken) {
          document.getElementById("paymentsList").innerHTML = '<p class="info-message">Please log in to view payments.</p>';
          return;
        }
        if (currentUserRole === "dokter") {
          document.getElementById("paymentsList").innerHTML = '<p class="info-message">Doctors do not have access to payment information.</p>';
          document.getElementById("createPaymentSection").style.display = "none";
          return;
        }

        let url = `${PAYMENT_SERVICE_URL}/payments`;
        if (currentUserRole === "pasien") {
          url += `?user_id=${currentUserId}`;
        }

        try {
          const response = await fetch(url);
          const payments = await response.json();
          const paymentsListDiv = document.getElementById("paymentsList");
          paymentsListDiv.innerHTML = "";

          if (!Array.isArray(payments) || payments.length === 0) {
            paymentsListDiv.innerHTML = '<p class="info-message">No payments found.</p>';
            return;
          }

          payments.forEach((payment) => {
            const paymentCard = document.createElement("div");
            paymentCard.className = "card payment-card";
            let buttons = "";
            if (currentUserRole === "admin" && payment.status === "pending") {
              buttons += `<button class="btn btn-primary" onclick="updatePaymentStatus(${payment.id}, 'completed')">Mark Completed</button> `;
              buttons += `<button class="btn btn-warning" onclick="updatePaymentStatus(${payment.id}, 'failed')">Mark Failed</button> `;
            }

            paymentCard.innerHTML = `
                        <h4>Payment ${payment.payment_reference}</h4>
                        <p><strong>Appointment ID:</strong> ${payment.appointment_id}</p>
                        <p><strong>Amount:</strong> Rp ${payment.amount.toLocaleString("id-ID")}</p>
                        <p><strong>Method:</strong> ${payment.payment_method}</p>
                        <p><strong>Status:</strong> <span class="status ${payment.status}">${payment.status.toUpperCase()}</span></p>
                        <p><strong>Created:</strong> ${new Date(payment.created_at).toLocaleString()}</p>
                        ${payment.paid_at ? `<p><strong>Paid:</strong> ${new Date(payment.paid_at).toLocaleString()}</p>` : ""}
                        <div class="card-actions">${buttons}</div>
                    `;
            paymentsListDiv.appendChild(paymentCard);
          });
        } catch (error) {
          document.getElementById("paymentsList").innerHTML = '<p class="error-message">Error loading payments. Check service connection.</p>';
          console.error("Error:", error);
        }
      }

      async function updatePaymentStatus(paymentId, status) {
        if (currentUserRole !== "admin" || !accessToken) {
          alert("Unauthorized action: Only admin can update payment status.");
          return;
        }
        try {
          const response = await fetch(`${PAYMENT_SERVICE_URL}/payments/${paymentId}/status`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${accessToken}`,
            },
            body: JSON.stringify({ status }),
          });
          const data = await response.json();
          alert(data.message);
          if (response.ok) {
            fetchPayments();
            if (status === "completed") {
              fetchAppointments();
            }
          } else {
            alert("Failed to update payment status: " + (data.message || "Unknown error"));
          }
        } catch (error) {
          alert("Error updating payment status. Check service connection.");
          console.error("Error:", error);
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        if (window.location.pathname.endsWith("login.html") || window.location.pathname.endsWith("register.html")) {
        } else {
          checkAllServices();
          showSection("home");
          updateAuthNav();
        }
      });
    </script>
  </body>
</html>
